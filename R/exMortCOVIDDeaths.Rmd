---
title: "COVID Mortality Data"
author: "Eugenio Paglino"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::github_document
---

```{r, echo=F, message=F,warning=F}

# Loading necessary packages

library(tidyverse)
library(lubridate)
library(lme4)
library(matrixStats)
library(patchwork)
library(knitr)
library(here)
library(ggrepel)

```

```{r, echo=FALSE, warning=F, message=F}

rm(list=ls())

here::i_am('R/exMortPerformance.Rmd')

inDir <- here::here('data','input')
outDir <- here::here('data','output')

```

```{r, echo=F, message=F, warning=F}

# Import historical county-monthly data downloaded from CDC WONDER
# https://wonder.cdc.gov/ucd-icd10.html
# NOTE: County-quarters with < 10 deaths are censored in these data

COVIDData <- list.files(
  here::here(inDir,'Data_CDC_Wonder','COVIDDeathsCM'),
  pattern = "*.txt",
  full.names = TRUE
) %>%
  map_dfr(
    ~ data.table::fread(
      .x,
      na.strings = c("Missing", "Suppressed", "Not Applicable"),
      keepLeadingZeros = TRUE,
      colClasses = c("character")
    )
  )

# Setting intuitive names

names(COVIDData) <-c('notes','countyName','FIPSCode',
                     'month','monthCode','deaths',
                     'population','CMR')

# Keeping only the variables we need

COVIDData <- COVIDData[,c('FIPSCode','monthCode','deaths')]

# Converting deaths from characters to integers

COVIDData <- COVIDData[ , deaths := as.integer(deaths)]

# We extract month and year from the monthCode variable and then
# create a monthYear date variable.

COVIDData <- COVIDData %>% 
  separate(monthCode, into=c('year','month')) %>%
  mutate(year = as.integer(year),
         month = as.integer(month),
         monthYear = make_date(year=year,month=month,day=1))

```

```{r, echo=F}

# Import population counts and information on county sets (groups of 
# counties created by the Census Bureau to have geographical units with
# at least 50.000 residents).

# We do not have yet population estimated for 2021, we thus use the 2020 values.
# This is not ideal but it is not worse compared to other more complex strategies

popData <- tibble(arrow::read_feather(here::here(outDir,'popDataMonthly.feather')))
countySets <- read.csv(here::here(inDir,'geo','countySets.csv'), colClasses = 'character')

```

```{r, echo=F}

# We add population counts to our data and assign each county to the 
# corresponding county set.

COVIDData <- COVIDData %>% left_join(popData, by = c('FIPSCode','year','month'))
COVIDData <- COVIDData %>% left_join(countySets, by = c('FIPSCode'))

COVIDData <- COVIDData %>% mutate(stateFIPS = if_else(stateFIPS == '11', '24', stateFIPS)) # Assign DC to Maryland

COVIDData <- COVIDData %>% drop_na()

```

```{r, echo=F}

# For convenience, let us keep a list of state groupings based on Census regions

northEast <- c('9','23','25','33','44','50','34','36','42')
midWest <- c('18','17','26','39','55','19','31','20','38','27','46','29')
south <- c('10','11','12','13','24','37','45','51','54','1','21','28','47','5','22','40','48')
west <- c('4','8','16','35','30','49','32','56','2','6','15','41','53')

newEngland <- c('9','23','25','33','44','50')
middleAtlantic <- c('34','36','42')
eastNorthCentral <- c('18','17','26','39','55')
westNorthCentral <- c('19','31','20','38','27','46','29')
southAtlantic <- c('10','11','12','13','24','37','45','51','54')
eastSouthCentral <- c('1','21','28','47')
westSouthCentral <- c('5','22','40','48')
mountain <- c('4','8','16','35','30','49','32','56')
pacific <- c('2','6','15','41','53')

```

```{r, echo=F}

COVIDData <- COVIDData %>% mutate(censusReg1 = case_when(stateFIPS %in% northEast ~ 'North East',
                                                         stateFIPS %in% midWest ~ 'Mid West',
                                                         stateFIPS %in% south ~ 'South',
                                                         stateFIPS %in% west ~ 'West'),
                                  censusReg2 = case_when(stateFIPS %in% newEngland ~ 'New England',
                                                         stateFIPS %in% middleAtlantic ~ 'Middle Atlantic',
                                                         stateFIPS %in% eastNorthCentral ~ 'East North Central',
                                                         stateFIPS %in% westNorthCentral ~ 'West North Central',
                                                         stateFIPS %in% southAtlantic ~ 'South Atlantic',
                                                         stateFIPS %in% eastSouthCentral ~ 'East South Central',
                                                         stateFIPS %in% westSouthCentral ~ 'West South Central',
                                                         stateFIPS %in% mountain ~ 'Mountain',
                                                         stateFIPS %in% pacific ~ 'Pacific'))

```

```{r, echo=F}

# We compute the monthly Crude Death Rate (CDR) for every 100.000 residents

COVIDData <- COVIDData %>% mutate(CDR=(deaths/pop)*100000,
                            logCDR = log(CDR))

```

To understand whether the monthly county-level data on COVID deaths released by the CDC is reliable, we can try to replicate familiar trends and patterns in COVID mortality. We start by plotting the national number of daily COVID deaths as estimated from the data. Because we only have data with monthly frequency, the number of monthly deaths was divided by 30 to obtain daily estimates.

```{r, echo=F, message=F, warning=F, fig.width=12, fig.cap='National Daily Deaths due to COVID'}

COVIDData %>%
  group_by(monthYear) %>%
  summarize(allDeaths = sum(deaths)/30) %>%
ggplot() +
  geom_smooth(mapping=aes(x=monthYear,y=allDeaths), span = 0.3, size=1, color='black') +
  labs(x='Time',
       y='Daily COVID Deaths')

```
We can further decompose the national-level data by census region as see if we observe the familiar patter where, for example, the North East was hit harder by the first wave while the South saw higher mortality in late 2020 and 2021.

```{r, echo=F, warning=F, message=F, fig.width=12, fig.cap='Daily Deaths due to COVID by Census Region'}
  
censusReg1Plot <- COVIDData %>%
  group_by(monthYear,censusReg1) %>%
  summarize(allDeaths = sum(deaths)/30) %>%
ggplot() +
  geom_smooth(mapping=aes(x=monthYear,y=allDeaths,color=censusReg1), 
              span = 0.3, size=1, se=F)
  
labelData <- tibble(ggplot_build(censusReg1Plot)$data[[1]]) %>%
  group_by(group) %>%
  filter(near(x,quantile(x,0.45),tol=10)) %>%
  ungroup() %>%
  slice_min(x,n=1) %>%
  select(x,y) %>%
  rename(monthYear=x, allDeaths=y) %>%
  mutate(censusReg1 = unique(COVIDData$censusReg1),
         monthYear = make_date(2020,12,1))

censusReg1Plot +
  #geom_text_repel(data=labelData,
  #                mapping=aes(x=monthYear,y=allDeaths,label=censusReg1),
  #                min.segment.length = 0,
  #                nudge_x = 100) +
  scale_color_brewer(palette="Set2") + 
  labs(x='Time',
       y='Daily COVID Deaths',
       color = 'Census Region') 

```

Finally, for the moment, we can further decompose each census region into its sub-regions to see how deaths were distributed within each area.

```{r, echo=F, message=F, warning=F, fig.width=12, fig.cap='Daily Deaths due to COVID by Census Sub-Region'}

COVIDData %>%
  group_by(monthYear,censusReg1,censusReg2) %>%
  summarize(allDeaths = sum(deaths)/30) %>%
ggplot() +
  geom_smooth(mapping=aes(x=monthYear,y=allDeaths,color=censusReg2), span = 0.3, size=1, se=F) +
  labs(x='Time',
       y='Daily COVID Deaths',
       color= 'Census Sub-Region') +
  facet_wrap(~censusReg1)

```
