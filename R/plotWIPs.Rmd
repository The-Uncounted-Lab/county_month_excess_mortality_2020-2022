---
title: "WIP viz prototypes for Nature"
author: "Joe A. Wasserman"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
library(USAboundaries)
library(sf)
library(colorspace)
library(tidyverse)
library(lubridate)
library(knitr)
library(here)

# set default chunk options
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  dev = "ragg_png",
  dpi = 144
)

# set global options
options(
  scipen = 999,
  verbose = FALSE
)

# set directories
here::i_am("R/plotWIPs.Rmd")

inDir <- here::here("data", "input")
outDir <- here::here("data", "output")
```

```{r import data}
monthlyEstimates <- read_csv(here::here(outDir, "exMortEstimatesMonthlyINLA.csv"))
metroRaw <- read_csv(here::here(inDir, "utilities", "FIPSmetroregion4cat.csv"))
BEARegions <- read_rds(here::here(inDir, "utilities", "stateBEARegionCrosswalk.rds"))
```

# Maps of relative county excess mortality as a % (excess / expected) by COVID wave and Metro status

* Large metro = NCHS categories 1 + 2

* Small/Medium Metro = NCHS category 3

* All Metro = NCH categories 1, 2, + 3

* Non-metro = 4


```{r plot data prep}

# identify deciles to guide setting cut-points for bins for plots
# plotDataRelative %>% filter(excDeathsRelative>0, monthYear >= date("2020-03-01")) %>% pull(excDeathsRelative) %>% quantile(probs = seq(0, 1, .1), type = 8, digits = 4)
breaksMap <- c(-Inf, 0, .1, .25, .45, .9, Inf)

# filter to pandemic months
plotData <- monthlyEstimates %>%
  filter(monthYear >= date("2020-03-01")) %>% 
  left_join(BEARegions, by = c("stateStr" = "state_abb")) %>% 
  mutate(
    excDeaths100k = 100000 * excDeathsMed / pop,
    excDeathsRelative = excDeathsMed / expDeathsMed,
    excDeathsRelativeBinned = cut(
      excDeathsRelative,
      breaks = breaksMap,
      ordered_result = TRUE
    )
  )

# color scale for corresponding number of bins
colorscaleGeyser21 <- colorspace::divergingx_hcl(21)
colorscaleGeyserSelect <- colorscaleGeyser21[c(6, 11, 13, 15, 18, 21)]

## Metropolitan status
metro <- metroRaw %>%
  select(
    FIPSCode = fips,
    metroCode = metro
  ) %>%
  mutate(
    FIPSCode = if_else(nchar(FIPSCode) < 5, paste0("0", FIPSCode), as.character(FIPSCode)),
    metroStatus = if_else(
      metroCode %in% c(1, 2),
      "Large Metro",
      "Other"
    ),
    metroStatus2 = case_when(
      metroCode %in% c(1, 2) ~ "Large Metro",
      metroCode %in% c(3) ~ "Medium or Small Metro",
      TRUE ~ "Non Metro"
    ),
    metroStatus3 = case_when(
      metroCode %in% c(1, 2, 3) ~ "All Metro",
      TRUE ~ "Non Metro"
    )
  )

# sf objects for plotting maps
us_counties_raw <- USAboundaries::us_counties()
usCounties <- names(us_counties_raw) %>%
  make.names(unique = TRUE) %>%
  purrr::set_names(us_counties_raw, .) %>%
  filter(jurisdiction_type %in% c("state", "district"))

usStates <- USAboundaries::us_states() %>%
  filter(jurisdiction_type %in% c("state", "district"))

# map data prep
# define waves, summarize data by wave, and add sf for plotting

plotDataMapWave <- plotData %>%
  mutate(
    wave = as_factor(
      case_when(
        between(monthYear, date("2020-03-01"), date("2020-06-01")) ~ "Initial period\n2020-03 -- 2020-06",
        between(monthYear, date("2020-07-01"), date("2020-09-01")) ~ "Second wave\n2020-07 -- 2020-09",
        between(monthYear, date("2020-10-01"), date("2021-03-01")) ~ "Third wave\n2020-10 -- 2021-03",
        between(monthYear, date("2021-04-01"), date("2021-07-01")) ~ "Trough\n2021-04 -- 2021-07",
        between(monthYear, date("2021-08-01"), date("2021-11-01")) ~ "Fourth wave (Delta)\n2021-08 -- 2021-11",
        monthYear >= date("2021-12-01") ~ "Fifth wave (Omicron)\n2021-12 -- ?",
        TRUE ~ NA_character_
      )
    )
  ) %>%
  filter(!is.na(wave)) %>%
  group_by(csCode, FIPSCode, stateFIPS, countyName, state, stateStr, region_bea, region_group_bea, wave) %>%
  summarize(
    across(
      c(expDeathsLow:imputedDeaths, excDeathsMed:excDeathsUp, excDeaths100k), 
      sum
    ),
    .groups = "drop"
  ) %>%
  left_join(metro, by = "FIPSCode") %>%
  mutate(
    excDeathsRelative = excDeathsMed / expDeathsMed,
    excDeathsRelativeBinned = cut(
      excDeathsRelative,
      breaks = breaksMap,
      ordered_result = TRUE
    )
  )

plotDataMapWaveGeo <- usCounties %>%
  merge(plotDataMapWave, by.x = "geoid", by.y = "FIPSCode")
```

```{r map plot }

# heuristic wave dates from https://www.pewresearch.org/politics/2022/03/03/the-changing-political-geography-of-covid-19-over-the-last-two-years/

gMap <- ggplot(
  plotDataMapWaveGeo,
  aes(
    fill = excDeathsRelativeBinned,
    geometry = geometry
  )
)

mapNationalUnfaceted <- gMap +
  geom_sf(
    color = "transparent"
  ) +
  geom_sf(
    data = usStates,
    fill = NA,
    color = "grey70",
    size = .1
  ) +
  coord_sf(
    xlim = c(-125, -66),
    ylim = c(24, 50),
    expand = FALSE
  ) +
  scale_fill_manual(
    values = colorscaleGeyserSelect
  ) +
  guides(fill = guide_legend(direction = "horizontal")) +
  theme_void() +
  theme(legend.position = "bottom")

mapNationalUnfaceted +
  facet_grid(
    cols = vars(metroStatus),
    rows = vars(wave)
  )

mapNationalUnfaceted +
  facet_grid(
    cols = vars(metroStatus3),
    rows = vars(wave)
  )

mapNationalUnfaceted +
  facet_grid(
    cols = vars(metroStatus2),
    rows = vars(wave)
  )
```

# Heatmaps of relative county-month excess mortality as a % (excess / expected) by census region and Metro status

* Large metro = NCHS categories 1 + 2

* Small/Medium Metro = NCHS category 3

* All Metro = NCH categories 1, 2, + 3

* Non-metro = 4

## Rows (counties) ordered by peak month + second-highest month

```{r heatmap plot}
plotDataHeatmap <- plotData %>%
  left_join(metro, by = "FIPSCode") %>%
  group_by(FIPSCode) %>%
  mutate(
    excDeathsRelativeNoInf = na_if(excDeathsRelative, Inf),
    excDeathsRelativeNoInf = na_if(excDeathsRelativeNoInf, -Inf),
    monthRank = rank(-excDeathsRelativeNoInf, ties.method = "first", na.last = "keep"),
    monthMax1 = if_else(monthRank == 1L, monthYear, NA_Date_),
    monthMax2 = if_else(monthRank == 2L, monthYear, NA_Date_),
    monthMax3 = if_else(monthRank == 3L, monthYear, NA_Date_)
  ) %>%
  fill(
    monthMax1,
    monthMax2,
    monthMax3
  ) %>%
  ungroup() %>%
  arrange(
    # maxMonth
    monthMax1,
    monthMax2,
    monthMax1
  ) %>%
  mutate(
    FIPSPlotOrder = forcats::as_factor(FIPSCode)
  )


gHeatmap <- ggplot(
  plotDataHeatmap,
  aes(
    y = FIPSPlotOrder,
    x = monthYear,
    fill = excDeathsRelativeBinned
  )
)

(heatmapUnfaceted <- gHeatmap +
  geom_tile(
    color = "transparent"
  ) +
  scale_fill_manual(
    values = colorscaleGeyserSelect
  ) +
  scale_x_date(breaks = scales::breaks_width(width = "12 months")) +
  scale_y_discrete(
    labels = NULL,
    limits = rev
  ) +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank()
  ))

heatmapUnfaceted +
  facet_grid(
    rows = vars(metroStatus),
    scales = "free_y",
    space = "free_y"
  )

heatmapUnfaceted +
  facet_grid(
    rows = vars(metroStatus3),
    scales = "free_y",
    space = "free_y"
  )

heatmapUnfaceted +
  facet_grid(
    rows = vars(metroStatus2),
    scales = "free_y",
    space = "free_y"
  )

heatmapUnfaceted +
  facet_grid(
    rows = vars(metroName),
    scales = "free_y",
    space = "free_y"
  )

heatmapUnfaceted +
  facet_grid(
    rows = vars(region_group_bea),
    scales = "free_y",
    space = "free_y"
  )

heatmapUnfaceted +
  facet_grid(
    rows = vars(region_bea),
    scales = "free_y",
    space = "free_y"
  )

heatmapUnfaceted +
  ggh4x::facet_grid2(
    rows = vars(metroStatus),
    cols = vars(region_group_bea),
    scales = "free_y",
    independent = "y"
  )

heatmapUnfaceted +
  ggh4x::facet_grid2(
    rows = vars(metroStatus3),
    cols = vars(region_group_bea),
    scales = "free_y",
    independent = "y"
  )

heatmapUnfaceted +
  ggh4x::facet_grid2(
    rows = vars(metroStatus2),
    cols = vars(region_group_bea),
    scales = "free_y",
    independent = "y"
  )
```

## Rows (counties) ordered by unsupervised clustering

NB: Haven't been able to generate a visually patterned order this way, so not outputting it.

```{r clustered heatmaps, eval=FALSE, include=FALSE}

# attempt to hierarchical clustering and sort for more visually informative heatmaps
dataForClust <- plotData %>%
  select(FIPSCode, monthYear, excDeaths100k) %>%
  pivot_wider(
    names_from = monthYear,
    values_from = excDeaths100k,
    names_sort = TRUE
  )

dataForClustMatrix <- dataForClust %>%
  select(-FIPSCode) %>%
  as.matrix()

rownames(dataForClustMatrix) <- dataForClust[["FIPSCode"]]

distMatrixEuclidean <- proxy::dist(
  x = dataForClustMatrix,
  method = "Euclidean",
  diag = TRUE,
  upper = TRUE,
  by_rows = TRUE,
  auto_convert_data_frames = TRUE
)

distMatrixMahalanobis <- proxy::dist(
  x = dataForClustMatrix,
  method = "Mahalanobis",
  diag = TRUE,
  upper = TRUE,
  by_rows = TRUE,
  auto_convert_data_frames = TRUE
)

dataClust <- fastcluster::hclust(
  distMatrixMahalanobis,
  method = "average"
) %>%
  dendsort::dendsort()

plotDataOrder <- tibble(
  FIPSCode = dataClust[["labels"]],
  order = dataClust[["order"]]
)

plotDataHeatmapHeatmapOrdered <- plotData %>%
  left_join(plotDataOrder, by = "FIPSCode") %>%
  left_join(metro, by = "FIPSCode") %>%
  arrange(order) %>%
  mutate(
    FIPSPlotOrder = forcats::as_factor(FIPSCode)
  )

gHeatmapOrdered <- ggplot(
  plotDataHeatmapHeatmapOrdered,
  aes(
    y = FIPSPlotOrder,
    x = monthYear,
    fill = excDeathsRelativeBinned
  )
)

gHeatmapOrdered +
  geom_tile(
    color = "transparent"
  ) +
  scale_fill_manual(
    values = colorscaleGeyserSelect
  ) +
  scale_x_date(breaks = scales::breaks_width(width = "6 months")) +
  scale_y_discrete(
    labels = NULL,
    limits = rev
  ) +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal() +
  coord_fixed()

gHeatmapOrdered +
  geom_tile(
    color = "transparent"
  ) +
  scale_fill_manual(
    values = colorscaleGeyserSelect
  ) +
  ggh4x::facet_nested(
    rows = vars(region_group_bea, metroStatus),
    scales = "free_y",
    space = "free_y",
    nest_line = element_line()
  ) +
  scale_x_date(breaks = scales::breaks_width(width = "6 months")) +
  scale_y_discrete(
    labels = NULL,
    limits = rev
  ) +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal()

gHeatmapOrdered +
  geom_tile(
    color = "transparent"
  ) +
  scale_fill_manual(
    values = colorscaleGeyserSelect
  ) +
  facet_grid(
    rows = vars(region_bea),
    scales = "free_y",
    space = "free_y"
  ) +
  scale_x_date(breaks = scales::breaks_width(width = "6 months")) +
  scale_y_discrete(
    labels = NULL,
    limits = rev
  ) +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal()
```
