---
title: "Creating the Final Data"
author: "Eugenio Paglino"
date: "\today"
output:
  html_document
---


```{r, echo=F, include=F}

knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)

```

```{r}

# Loading necessary packages

library(tidyverse)
library(lubridate)
library(here)

# Set seed for the Rmd

set.seed(42)

```

```{r, echo=FALSE, message=F, warning=F}

# Do not rely on this to completely clean your environment
# Better to do a full restart of R before running

rm(list=ls())

here::i_am('R/dataCreation.Rmd')

inDir <- here::here('data','input')
outDir <- here::here('data','output')

```

```{r}

FIPSFixes <- read_csv(here::here(inDir,'FIPSHarmonization','FIPSFixes.csv'))

```

```{r}

# Import historical county-month data downloaded from CDC WONDER
# https://wonder.cdc.gov/ucd-icd10.html
# NOTE: County-months with < 10 deaths are censored in these data

ACData <- list.files(
  here::here(inDir,'CDC','AllCausesMonthly'),
  pattern = "*.txt",
  full.names = TRUE
) %>%
  map_dfr(
    ~ data.table::fread(
      .x,
      na.strings = c("Missing", "Suppressed", "Not Applicable"),
      keepLeadingZeros = TRUE,
      colClasses = c("character")
    )
  )

ACData <- as.tibble(ACData)

# Setting intuitive names

ACData <- ACData %>%
  select('FIPSCode'='County Code',
         'monthCode'='Month Code',
         'deaths'='Deaths',
         'FIPSCode2021'='Residence County Code')

ACData <- ACData %>% 
  mutate(FIPSCode = coalesce(FIPSCode, FIPSCode2021))

# Keeping only the variables we need

ACData <- ACData %>% select(FIPSCode,monthCode,deaths)

# We extract month and year from the monthCode variable and then
# create a monthYear date variable.

ACData <- ACData %>% 
  separate(monthCode, into=c('year','month')) %>%
  mutate(across(c(deaths,year,month),as.integer))

# We harmonize the FIPS codes

ACData <- ACData %>%
  left_join(FIPSFixes,by='FIPSCode') %>%
  mutate(FIPSCode = if_else(is.na(newFIPSCode),FIPSCode,newFIPSCode)) %>%
  select(-newFIPSCode) 

```

```{r}

ACData %>%
  filter(year==2021) %>%
  group_by(month) %>%
  summarise(deaths=sum(deaths,na.rm=T)) %>%
  pull(deaths) %>%
  sum()

```

```{r}

# Import historical county-year data downloaded from CDC WONDER
# https://wonder.cdc.gov/ucd-icd10.html
# NOTE: County-years with < 10 deaths are censored in these data

ACYearlyData <- list.files(
  here::here(inDir,'CDC','AllCausesYearly'),
  pattern = "*.txt",
  full.names = TRUE
) %>%
  map_dfr(
    ~ data.table::fread(
      .x,
      na.strings = c("Missing", "Suppressed", "Not Applicable"),
      keepLeadingZeros = TRUE,
      colClasses = c("character")
    )
  )

ACYearlyData <- as.tibble(ACYearlyData)

ACYearlyData <- ACYearlyData %>%
  select('FIPSCode'='County Code',
         'year'='Year Code',
         'deaths'='Deaths',
         'FIPSCode2021'='Residence County Code')

ACYearlyData <- ACYearlyData %>% 
  mutate(FIPSCode = coalesce(FIPSCode,FIPSCode2021))

# Keeping only the variables we need

ACYearlyData <- ACYearlyData %>% select(FIPSCode,year,deaths)

ACYearlyData <- ACYearlyData %>% 
  mutate(across(c(deaths,year),as.integer))

# We harmonize the FIPS codes

ACYearlyData <- ACYearlyData %>%
  left_join(FIPSFixes,by='FIPSCode') %>%
  mutate(FIPSCode = if_else(is.na(newFIPSCode),FIPSCode,newFIPSCode)) %>%
  select(-newFIPSCode)

```

```{r}

# Import historical county-month data downloaded from CDC WONDER
# https://wonder.cdc.gov/ucd-icd10.html
# NOTE: County-months with < 10 deaths are censored in these data

COVIDYearlyData <- list.files(
  here::here(inDir,'CDC','COVIDUCDYearly'),
  pattern = "*.txt",
  full.names = TRUE
) %>%
  map_dfr(
    ~ data.table::fread(
      .x,
      na.strings = c("Missing", "Suppressed", "Not Applicable"),
      keepLeadingZeros = TRUE,
      colClasses = c("character")
    )
  )

# Setting intuitive names

COVIDYearlyData <- COVIDYearlyData %>%
  select('FIPSCode'='Residence County Code',
         'year'='Year Code',
         'deaths'='Deaths')

# Keeping only the variables we need

COVIDYearlyData <- COVIDYearlyData %>%
  select(FIPSCode,year,deaths)

COVIDYearlyData <- COVIDYearlyData %>% 
  mutate(COVIDDeaths = as.integer(deaths),
         year = as.integer(year)) %>%
  select(-c('deaths'))

# We harmonize the FIPS codes

COVIDYearlyData <- COVIDYearlyData %>%
  left_join(FIPSFixes,by='FIPSCode') %>%
  mutate(FIPSCode = if_else(is.na(newFIPSCode),FIPSCode,newFIPSCode)) %>%
  select(-newFIPSCode)

```

```{r}

# Import population counts and information on county sets (groups of 
# counties created by the Census Bureau to have geographical units with
# at least 50.000 residents).

popData <- tibble(arrow::read_feather(here::here(outDir,'popDataMonthly.feather')))

popData <- popData %>%
  filter(year>=2010)

countySets <- read_csv(here::here(inDir,'geo','countySets.csv'), 
                       col_types = cols(csCode=col_character(),
                                        csName=col_character(),
                                        countyName=col_character(),
                                        stateFIPS=col_integer(),
                                        countyFIPS=col_integer(),
                                        FIPSCode=col_character()))

states <- read_csv(here::here(inDir,'utilities','states.csv'),
                   col_types = cols(state=col_character(),
                                    stateStr=col_character(),
                                    stateFIPS=col_integer()))

```

```{r}

popDataYearly <- popData %>%
  group_by(FIPSCode,year) %>%
  summarise(pop=mean(pop,na.rm=T)) %>%
  ungroup()

```

```{r}

# We harmonize the FIPS code here too

countySets <- countySets %>%
  left_join(FIPSFixes,by='FIPSCode') %>%
  mutate(FIPSCode = if_else(is.na(newFIPSCode),FIPSCode,newFIPSCode)) %>%
  select(-newFIPSCode) %>%
  mutate(csCode = if_else(FIPSCode == '02140','02CS005',csCode),
         csName = if_else(FIPSCode == '02140','Northern Alaska',csName),
         countyName = if_else(FIPSCode == '02140','Northern Alaska',countyName),
         countyFIPS = if_else(FIPSCode == '02140',140L,countyFIPS),
         csCode = if_else(FIPSCode == '02232','02CS006',csCode),
         csName = if_else(FIPSCode == '02232','Southeast Alaska',csName),
         countyName = if_else(FIPSCode == '02232','Southeast Alaska',countyName),
         countyFIPS = if_else(FIPSCode == '02232',232L,countyFIPS),
         csCode = if_else(FIPSCode == '02010','02CS007',csCode),
         csName = if_else(FIPSCode == '02010','Southwest Alaska',csName),
         countyName = if_else(FIPSCode == '02010','Southwest Alaska',countyName),
         countyFIPS = if_else(FIPSCode == '02010',10L,countyFIPS),
         csCode = if_else(FIPSCode == '02158','02CS007',csCode),
         csName = if_else(FIPSCode == '02158','Southwest Alaska',csName),
         countyName = if_else(FIPSCode == '02158','Southwest Alaska',countyName),
         countyFIPS = if_else(FIPSCode == '02158',158L,countyFIPS),
         csCode = if_else(FIPSCode == '46102','46CS010',csCode),
         csName = if_else(FIPSCode == '46102','Southwest Central South Dakota',csName),
         countyName = if_else(FIPSCode == '46102','Southwest Central South Dakota',countyName),
         countyFIPS = if_else(FIPSCode == '46102',102L,countyFIPS)) %>%
  filter(stateFIPS*1000 + countyFIPS == as.double(FIPSCode)) %>%
  distinct()

```

```{r}

# We create two tibbles needed to create complete datasets with all
# county-months or county-years even when the original data is missing
# or suppressed. To fill the missing data when we wish to do so, we 
# create an imputedDeaths variable sampled from a Beta distribution 
# with parameters alpha=2, and beta=2. We multiply each realization from
# this distribution by 9 so that it ranges from 0 to 9 (the potential
# values for suppressed deaths). We apply rounding to the result to
# ensure that we have an integer value.

FIPSCodes <- as.character(unique(countySets$FIPSCode))

simData <- crossing(year=2015:2022,
                    month=1:12,
                    FIPSCode=FIPSCodes)

simData <- simData %>%
  mutate(imputedDeaths = round(rbeta(nrow(simData),2.25,2)*9)) %>%
  filter(!(year==2022 & month>2))

simDataYearly <- crossing(year=2010:2022,
                          FIPSCode=FIPSCodes)

simDataYearly <- simDataYearly %>%
  mutate(imputedDeaths = round(rbeta(nrow(simDataYearly),2.25,2)*9))

```

```{r}

ACDataComplete <- simData %>%
  left_join(ACData,by=c('FIPSCode','year','month')) %>%
  mutate(imputedDeaths = if_else(is.na(deaths),imputedDeaths,as.double(deaths)),
         monthYear = make_date(year=year,month=month,day=1)) 

```

```{r}

# We add population counts to our data and assign each county to the 
# corresponding county set.

ACDataComplete <- ACDataComplete %>% 
  left_join(popData, by = c('FIPSCode','year','month')) %>% 
  left_join(countySets, by = c('FIPSCode')) %>%
  left_join(states, by = c('stateFIPS'))

# The step below is needed to collapse multiple counties with the same
# harmonized FIPS code into one. So far, the data still contains counties
# assigned to the same harmonized FIPS as separate observations.

# Sum is the appropriate aggregation unit for deaths and inputedDeaths
# because those have a different value for each of these counties.
# Mean is the appropriate aggregation unit for the population because the 
# popData file already uses harmonized counties so that the multiple
# counties with the same harmonized FIPS code already share the same
# population value (corresponding to the sum of the population of all 
# the counties with the same FIPS).

# The same rational applies for the similar cells dealing with the
# yearly all-cause death data and the COVID data

ACDataComplete <- ACDataComplete %>%
  group_by(FIPSCode,countyName,csCode,csName,stateFIPS,state,year,month) %>%
  summarize(deaths = sum(deaths),
            imputedDeaths = sum(imputedDeaths),
            pop = mean(pop)) %>%
  ungroup()

```

```{r}

# Construct data frame of state abbreviations + divisions, plus DC
census_divisions <- tibble(
  state = state.name,
  census_division = state.division,
  census_region = state.region
) %>%
  add_row(
    state = "District of Columbia",
    census_division = "South Atlantic",
    census_region = "South"
  )

```

```{r}

ACDataComplete <- ACDataComplete %>% 
  left_join(census_divisions,by='state')

```

```{r}

# We compute the monthly Crude Death Rate (CDR) for every 100.000 residents

ACDataComplete <- ACDataComplete %>% 
  mutate(CDR=(deaths/pop)*100000,
         logCDR = log(CDR))

```

```{r}

ACYearlyDataComplete <- simDataYearly %>%
  left_join(ACYearlyData,by=c('FIPSCode','year')) %>%
  mutate(imputedDeaths = if_else(is.na(deaths),imputedDeaths,as.double(deaths))) 

```

```{r}

# We add population counts to our data and assign each county to the 
# corresponding county set.

ACYearlyDataComplete <- ACYearlyDataComplete %>% 
  left_join(popDataYearly, by = c('FIPSCode','year')) %>% 
  left_join(countySets, by = c('FIPSCode')) %>%
  left_join(states, by = c('stateFIPS'))


ACYearlyDataComplete <- ACYearlyDataComplete %>%
  group_by(FIPSCode,countyName,csCode,csName,stateFIPS,state,year) %>%
  summarize(deaths = sum(deaths),
            imputedDeaths = sum(imputedDeaths),
            pop = mean(pop)) %>%
  ungroup()

```

```{r}

# We compute the monthly Crude Death Rate (CDR) for every 100.000 residents

ACYearlyDataComplete <- ACYearlyDataComplete %>% 
  mutate(CDR=(deaths/pop)*100000,
  logCDR = log(CDR))

```

```{r}

ACYearlyDataComplete <- ACYearlyDataComplete %>% 
  left_join(census_divisions,by='state')

```

```{r}

COVIDYearlyDataComplete <- filter(simDataYearly,year>2019) %>%
  left_join(COVIDYearlyData,by=c('FIPSCode','year')) %>%
  mutate(imputedCOVIDDeaths = if_else(is.na(COVIDDeaths),imputedDeaths,as.double(COVIDDeaths))) 

```

```{r}

# We add population counts to our data and assign each county to the 
# corresponding county set.

COVIDYearlyDataComplete <- COVIDYearlyDataComplete %>% 
  left_join(popDataYearly, by = c('FIPSCode','year')) %>% 
  left_join(countySets, by = c('FIPSCode')) %>%
  left_join(states, by = c('stateFIPS'))

COVIDYearlyDataComplete <- COVIDYearlyDataComplete %>%
  group_by(FIPSCode,countyName,csCode,csName,stateFIPS,state,year) %>%
  summarize(COVIDDeaths = sum(COVIDDeaths),
            imputedCOVIDDeaths = sum(imputedCOVIDDeaths),
            pop = mean(pop)) %>%
  ungroup()

```

```{r}

COVIDYearlyDataComplete <- COVIDYearlyDataComplete %>% 
  left_join(census_divisions,by='state')

```

```{r}

ACDataYearly <- ACData %>%
  filter(year<2020) %>%
  group_by(FIPSCode,year) %>%
  summarize(deaths = sum(deaths,na.rm = T)) %>%
  ungroup() %>%
  rename(deathsMonthly=deaths)

suppressionData <- ACYearlyData %>%
  filter(between(year,2015,2019)) %>%
  left_join(ACDataYearly,by=c('FIPSCode','year')) %>%
  group_by(FIPSCode) %>%
  summarize(deathsDiffPct = max((deaths/deathsMonthly)-1),
            deathsDiffAbs = max(deaths-deathsMonthly),
            across(c(deaths,deathsMonthly), ~ sum(.x))) %>%
  ungroup() %>%
  select(FIPSCode,
         deathsTotal=deaths,
         deathsTotalMonthly=deathsMonthly,
         deathsDiffAbs,
         deathsDiffPct)

```

```{r, echo=F}

suppressionData %>%
  write_csv(file=here::here(outDir,'suppressionData.csv'))

```

```{r}

# We save all the data so that we do not have to repeat this set of 
# operations each time

arrow::write_feather(countySets, here::here(outDir,'countySetsFinal.feather'))
arrow::write_feather(popData, here::here(outDir,'popDataMonthlyAlt.feather'))
arrow::write_feather(popDataYearly, here::here(outDir,'popDataYearly.feather'))
arrow::write_feather(ACDataComplete, here::here(outDir,'ACData.feather'))
arrow::write_feather(ACYearlyDataComplete, here::here(outDir,'ACYearlyData.feather'))
arrow::write_feather(COVIDYearlyDataComplete, here::here(outDir,'COVIDYearlyData.feather'))

```
